name: CI

on:
  push:
    branches: ["main", "cicd"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:

  # ==========================================
  # 1. Backend Test (Gradle + Postgres)
  # ==========================================
  backend-test:
    name: Backend Test (Gradle + Postgres)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Backend
    services:
      postgres:
        image: postgres:15
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: admin
          POSTGRES_DB: apartment_db
        options: >-
          --health-cmd="pg_isready -U postgres -d apartment_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Wait for DB
        run: |
          until pg_isready -h localhost -U postgres; do sleep 2; done

      - name: Run Gradle Tests
        run: |
          chmod +x gradlew
          ./gradlew test

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-report
          path: Backend/build/reports/tests/test



  # ==========================================
  # 2. Build + Push Backend Image
  # ==========================================
  build-backend:
    name: Build & Push Backend Image
    runs-on: ubuntu-latest
    needs: backend-test

    steps:
      - uses: actions/checkout@v4

      - name: Login to Registry
        run: echo "${{ secrets.REGISTRY_TOKEN }}" | \
          docker login -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin "${{ secrets.REGISTRY_URL }}"

      - name: Build Backend Image
        run: |
          docker build -f Backend/Dockerfile -t backend:${{ github.sha }} Backend
          docker tag backend:${{ github.sha }} \
            ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}/apartment-backend:${{ github.sha }}

      - name: Push Backend Image
        run: |
          docker push \
            ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}/apartment-backend:${{ github.sha }}



  # ==========================================
  # 3. Build + Push Frontend Image
  # ==========================================
  build-frontend:
    name: Build & Push Frontend Image
    runs-on: ubuntu-latest
    needs: build-backend

    steps:
      - uses: actions/checkout@v4

      - name: Login to Registry
        run: echo "${{ secrets.REGISTRY_TOKEN }}" | \
          docker login -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin "${{ secrets.REGISTRY_URL }}"

      - name: Build Frontend Image
        run: |
          docker build -f Frontend/Dockerfile -t frontend:${{ github.sha }} Frontend
          docker tag frontend:${{ github.sha }} \
            ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}/apartment-frontend:${{ github.sha }}

      - name: Push Frontend Image
        run: |
          docker push \
            ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}/apartment-frontend:${{ github.sha }}



  # ==========================================
  # 4. E2E Test (pull images from registry only)
  # ==========================================
  e2e:
    name: E2E Test (Docker Compose + Cypress)
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]

    env:
      BACKEND_IMAGE: ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}/apartment-backend:${{ github.sha }}
      FRONTEND_IMAGE: ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}/apartment-frontend:${{ github.sha }}
      COMPOSE_FILE: docker-compose.ci.yml
      BASE_URL: http://localhost:3000

    steps:
      - uses: actions/checkout@v4

      - name: Login Docker Registry
        run: echo "${{ secrets.REGISTRY_TOKEN }}" | \
          docker login -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin "${{ secrets.REGISTRY_URL }}"

      - name: Create CI docker-compose file
        run: |
          cat > docker-compose.ci.yml <<EOF
          services:
            backend:
              image: ${BACKEND_IMAGE}
              ports:
                - "8080:8080"

            frontend:
              image: ${FRONTEND_IMAGE}
              ports:
                - "3000:80"

            apartment-db:
              image: postgres:15
              environment:
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: admin
                POSTGRES_DB: apartment_db
              ports:
                - "5432:5432"
          EOF

      - name: Start Docker Compose
        run: docker compose -f docker-compose.ci.yml up -d

      - name: Wait Backend
        run: |
          for i in {1..60}; do
            curl -fsS http://localhost:8080/actuator/health && exit 0
            sleep 2
          done
          exit 1

      - name: Wait Frontend
        run: |
          for i in {1..60}; do
            curl -fsS http://localhost:3000 && exit 0
            sleep 2
          done
          exit 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Cypress
        run: |
          cd Frontend
          npm ci
          npx cypress install

      - name: Run Cypress E2E
        run: |
          cd Frontend
          npx cypress run --headless

      - name: Teardown
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v



  # ==========================================
  # 5. Summary
  # ==========================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend-test, build-backend, build-frontend, e2e]
    steps:
      - run: echo "ðŸŽ‰ CI/CD Completed Successfully!"
